<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Arissa Events</title>
    <meta name="description" content="Душевные события, где жизнь снова становится вкусной" />
    <meta name="author" content="Arissa Events" />
    <link rel="manifest" href="/manifest.webmanifest" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Playfair+Display:wght@400;500;600;700&family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet" crossorigin>

    <meta property="og:title" content="Arissa Events" />
    <meta property="og:description" content="Душевные события, где жизнь снова становится вкусной" />
    <meta property="og:type" content="website" />

    <!-- Telegram Web App Script - now handled by @twa-dev/sdk package -->
  </head>

  <body>
    <div id="root"></div>
    <script>
      (async () => {
        try {
          const response = await fetch('/manifest.json', { cache: 'no-store' });
          const manifest = await response.json();
          const currentVersion = localStorage.getItem('sdk_version');

          if (currentVersion && currentVersion !== manifest.version) {
            // Show update screen matching the app's loading screen style
            document.body.innerHTML = `
              <div style="
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, hsl(155 30% 10%) 0%, hsl(150 30% 6%) 40%, hsl(0 0% 0%) 100%);
                font-family: Montserrat, sans-serif;
                color: white;
              ">
                <div style="text-align: center; space-y-4;">
                  <div style="
                    width: 2rem;
                    height: 2rem;
                    margin: 0 auto 1rem;
                    border: 3px solid hsl(42 75% 55%);
                    border-top-color: transparent;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                  "></div>
                  <p style="
                    margin: 0;
                    font-family: Montserrat, sans-serif;
                    color: white;
                  ">Обновление приложения...</p>
                </div>
              </div>
              <style>
                @keyframes spin {
                  to { transform: rotate(360deg); }
                }
              </style>
            `;

            // Clear all caches for clean update
            if ('caches' in window) {
              caches.keys().then(names => {
                names.forEach(name => caches.delete(name));
              });
            }

            // Auto-reload after showing the update screen for 2 seconds
            setTimeout(() => {
              localStorage.setItem('sdk_version', manifest.version);
              location.reload();
            }, 2000);

            return;
          }

          // Skip CSS loading from manifest - use app's own CSS
          console.log('[Platform] Skipping manifest CSS loading - using app CSS');

          // Load fonts with checksum check
          const fontsChecksum = localStorage.getItem('fonts_checksum');
          if (!fontsChecksum || fontsChecksum !== manifest.checksums?.['tilda-script-light.otf']) {
            // Load Tilda Script font
            const fontLink = document.createElement('link');
            fontLink.rel = 'preload';
            fontLink.href = manifest.fonts?.['tilda-script'] || '/fonts/tilda-script-light.otf';
            fontLink.as = 'font';
            fontLink.type = 'font/otf';
            fontLink.crossOrigin = 'anonymous';
            document.head.appendChild(fontLink);

            const fontFace = new FontFace('Tilda Script', `url(${manifest.fonts?.['tilda-script'] || '/fonts/tilda-script-light.otf'})`);
            fontFace.load().then(() => {
              document.fonts.add(fontFace);
            }).catch(() => {
              console.warn('Font loading failed');
            });

            localStorage.setItem('fonts_checksum', manifest.checksums?.['tilda-script-light.otf'] || '');
          }

          // Load platform CSS first (base styles)
          const platformCss = document.createElement('link');
          platformCss.rel = 'stylesheet';
          platformCss.href = '/platform/platform.style.css?v=' + Date.now();
          document.head.appendChild(platformCss);

          // Load custom app CSS after platform CSS
          const customCss = document.createElement('link');
          customCss.rel = 'stylesheet';
          customCss.href = '/index.css?v=' + Date.now();
          document.head.appendChild(customCss);

          // Wait for both CSS files to load before proceeding
          let cssLoaded = 0;
          const totalCss = 2;

          const checkCssReady = () => {
            cssLoaded++;
            if (cssLoaded === totalCss) {
              console.log('[CSS] All CSS files loaded successfully');
            }
          };

          platformCss.onload = () => {
            console.log('[CSS] Platform CSS loaded successfully');
            checkCssReady();
          };
          platformCss.onerror = (error) => {
            console.error('[CSS] Failed to load platform CSS:', error);
            checkCssReady(); // Continue even if failed
          };

          customCss.onload = () => {
            console.log('[CSS] Custom app CSS loaded successfully');
            checkCssReady();
          };
          customCss.onerror = (error) => {
            console.error('[CSS] Failed to load custom app CSS:', error);
            checkCssReady(); // Continue even if failed
          };

          // Load Platform SDK Bundle as regular script (not module)
          const platformScript = document.createElement('script');
          platformScript.src = '/platform/platform.platform.iife.js?v=' + Date.now();
          platformScript.onload = () => {
            console.log('[Platform] Bundle loaded, checking Platform SDK...');
            console.log('[Platform] window.Platform available:', !!window.Platform);
            console.log('[Platform] window.Platform.sdk available:', !!window.Platform?.sdk);
            console.log('[Platform] window.Platform.modules available:', !!window.Platform?.modules);
            console.log('[Platform] window.Platform.init available:', !!window.Platform.init);

            // Wait a bit for modules to load dynamically
            setTimeout(() => {
              console.log('[Platform] After timeout - checking modules again...');
              console.log('[Platform] window.Platform.modules available:', !!window.Platform?.modules);
              console.log('[Platform] window.Platform.init available:', !!window.Platform.init);

              // Load the custom app code immediately to override the default
              const appScript = document.createElement('script');
              appScript.src = '/platform/app.iife.js?v=' + Date.now();
              appScript.onload = () => {
                console.log('[App] Custom app code loaded successfully');

                // Now initialize the app
                if (window.ArissaEventsApp && typeof window.ArissaEventsApp.initApp === 'function') {
                  console.log('[App] Calling ArissaEventsApp.initApp...');
                  window.ArissaEventsApp.initApp().then(() => {
                    console.log('[App] ArissaEventsApp.initApp completed successfully');
                  }).catch(error => {
                    console.error('[App] ArissaEventsApp.initApp failed:', error);
                  });
                } else {
                  console.error('[App] ArissaEventsApp.initApp function not found');
                  console.log('[App] Available:', window.ArissaEventsApp);
                }
              };
              appScript.onerror = (error) => {
                console.error('[App] Failed to load custom app code:', error);
              };
              document.head.appendChild(appScript);
            }, 1000); // Wait 1 second for dynamic imports
          };
          platformScript.onerror = (error) => {
            console.error('[Platform] Failed to load platform bundle:', error);
          };
          document.head.appendChild(platformScript);

          // Skip platform CSS loading for now - use app's own CSS
          console.log('[Platform] Skipping CSS loading - using app CSS');

          console.log(`[Platform] Loaded v${manifest.version}`);

          // Update version for cache busting
          localStorage.setItem('sdk_version', manifest.version);

          // Platform bundle is already loaded above, no need for separate SDK loading
          console.log(`[Platform] Fully loaded v${manifest.version}`);
          localStorage.setItem('sdk_version', manifest.version);
        } catch (error) {
          console.error('Failed to load SDK:', error);
        }
      })();
    </script>
  </body>
</html>
